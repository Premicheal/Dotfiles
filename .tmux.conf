# Plugin and theme setup
set -g @plugin 'ofirgall/tmux-window-name'
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-sensible '
set -g @plugin 'omerxx/tmux-sessionx'

# Catppuccin theme settings
set -g @plugin 'catppuccin/tmux'
set -g @catppuccin_flavour 'mocha'
set -g @catppuccin_window_left_separator ""
set -g @catppuccin_window_right_separator ""
set -g @catppuccin_window_number_position "left"
set -g @catppuccin_window_middle_separator ""
set -g @catppuccin_window_default_fill "number"
set -g @catppuccin_window_current_fill "number"
set -g @catppuccin_status_modules_right "application session"
set -g @catppuccin_status_left_separator "â–ˆ"
set -g @catppuccin_status_right_separator ""
set -g @catppuccin_status_right_separator_inverse "yes"
set -g @catppuccin_status_fill "all"
set -g @catppuccin_status_connect_separator "no"

# General settings
set -g mouse on
set -g base-index 1
set -g pane-base-index 1
set -g history-limit 1000000
set -g status on
set -g status-right-length 100
set -g status-right '#(tmux list-sessions -F "#{session_name}" | tr "\n" " ")'
set -g detach-on-destroy off
set -sg escape-time 10
set -g focus-events on
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",*256col*:Tc"

# Prefix and key bindings
unbind C-b
set -g prefix C-a
bind-key C-a send-prefix
bind c new-window -c "#{pane_current_path}"
bind C-c new-session -c "#{pane_current_path}"
bind '\' split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
bind '"' switch-client -n
unbind '%'
bind % switch-client -n
bind r source-file ~/.tmux.conf
bind -r ^ last-window
bind p previous-window
bind n next-window
bind f run-shell "tmux neww ~/.local/scripts/tmux-sessionizer"
bind C-f run-shell "tmux neww ~/.local/scripts/tmux-sessionizer"
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e; send-keys -M'"

# Vim-like pane navigation
is_vim="children=(); i=0; pids=( $(ps -o pid= -t '#{pane_tty}') ); \
while read -r c p; do [[ -n c && c -ne p && p -ne 0 ]] && children[p]+=\" $\{c\}\"; done <<< \"$(ps -Ao pid=,ppid=)\"; \
while (( $\{#pids[@]\} > i )); do pid=$\{pids[i++]\}; pids+=( $\{children[pid]-\} ); done; \
ps -o state=,comm= -p \"$\{pids[@]\}\" | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?|fzf)(diff)?$'"
bind "h" if-shell "$is_vim" 'send-keys C-h' { if -F '#{pane_at_left}' '' 'select-pane -L' }
bind "j" if-shell "$is_vim" 'send-keys C-j' { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind "k" if-shell "$is_vim" 'send-keys C-k' { if -F '#{pane_at_top}' '' 'select-pane -U' }
bind "l" if-shell "$is_vim" 'send-keys C-l' { if -F '#{pane_at_right}' '' 'select-pane -R' }
bind "s" if-shell "$is_vim" 'send-keys C-w s' { if -F '#{pane_at_right}' '' 'select-pane -R' }
bind "v" if-shell "$is_vim" 'send-keys C-w v' { if -F '#{pane_at_right}' '' 'select-pane -R' }

# Shell window navigation
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' { if -F '#{pane_at_left}' '' 'select-pane -L' }
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' { if -F '#{pane_at_top}' '' 'select-pane -U' }
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' { if -F '#{pane_at_right}' '' 'select-pane -R' }
bind-key -n 'C-\' if-shell "[ $(tmux display-message -p '#W') = 'snail' ]" { 'last-window' } { if-shell "[ $(tmux list-windows | grep -c 'snail') -eq 0 ]" 'new-window -n snail' 'select-window -t snail' }
bind-key -n '^]' if-shell "[ $(tmux display-message -p '#W') = 'lazygitt' ]" { 'last-window' } { if-shell "[ $(tmux list-windows | grep -c 'lazygitt') -eq 0 ]" "new-window -n lazygitt lazygit" "select-window -t lazygitt" }
bind-key -n '^_' switch-client -l
bind -n End send-key C-e
bind -n Home send-key C-a

# Copy mode key bindings
bind-key -T copy-mode-vi 'C-h' if -F '#{pane_at_left}' '' 'select-pane -L'
bind-key -T copy-mode-vi 'C-j' if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind-key -T copy-mode-vi 'C-k' if -F '#{pane_at_top}' '' 'select-pane -U'
bind-key -T copy-mode-vi 'C-l' if -F '#{pane_at_right}' '' 'select-pane -R'

# Plugin manager
run '~/.tmux/plugins/tpm/tpm'
